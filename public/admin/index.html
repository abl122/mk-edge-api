<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK-Edge Admin - Painel Administrativo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-chart-line"></i> MK-Edge Admin</h2>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-link active" onclick="showSection('dashboard', event)">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-link" onclick="showSection('tenants', event)">
                <i class="fas fa-building"></i>
                <span>Provedores/Tenants</span>
            </a>
            <a href="#" class="nav-link" onclick="showSection('plans', event)">
                <i class="fas fa-tags"></i>
                <span>Planos</span>
            </a>
            <a href="#" class="nav-link" onclick="showSection('integrations', event)">
                <i class="fas fa-plug"></i>
                <span>Integra√ß√µes</span>
            </a>
            <a href="#" class="nav-link" onclick="showSection('settings', event)">
                <i class="fas fa-cog"></i>
                <span>Configura√ß√µes</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="userDisplay">Admin</span>
            </div>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Sair
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="page-header">
                <h1>Dashboard</h1>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync"></i> Atualizar
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalTenants">0</h3>
                        <p>Total de Provedores</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeTenants">0</h3>
                        <p>Provedores Ativos</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalRevenue">R$ 0</h3>
                        <p>Receita Total Mensal</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="inactiveCount">0</h3>
                        <p>Assinaturas Vencidas</p>
                    </div>
                </div>
            </div>

            <div class="recent-section">
                <h2>Provedores Recentes</h2>
                <div id="recentTenants" class="tenants-list">
                    <p class="no-data">Carregando...</p>
                </div>
            </div>
        </section>

        <!-- Tenants Section -->
        <section id="tenants" class="content-section">
            <div class="page-header">
                <h1>Provedores/Tenants</h1>
                <button class="btn btn-primary" onclick="openNewTenantModal()">
                    <i class="fas fa-plus"></i> Novo Provedor
                </button>
            </div>

            <div class="filter-bar">
                <input type="text" id="tenantSearch" placeholder="Buscar por nome, CNPJ ou dom√≠nio..." 
                       onkeyup="filterTenants(this.value)">
                <select id="statusFilter" onchange="filterTenants()">
                    <option value="">Todos os Status</option>
                    <option value="active">Ativo</option>
                    <option value="inactive">Inativo</option>
                </select>
            </div>

            <div id="tenantsList" class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CNPJ</th>
                            <th>Dom√≠nio</th>
                            <th>Assinatura</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tenantsTableBody">
                        <tr><td colspan="6" class="no-data">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="content-section">
            <div class="page-header">
                <h1>Configura√ß√µes</h1>
            </div>

            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Sistema</h3>
                    <div class="setting-item">
                        <label>Vers√£o da API:</label>
                        <span id="apiVersion">v2.0.0</span>
                    </div>
                    <div class="setting-item">
                        <label>Ambiente:</label>
                        <span id="environment">production</span>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>Conta</h3>
                    <button class="btn btn-secondary" onclick="openChangePasswordModal()">
                        <i class="fas fa-key"></i> Alterar Senha
                    </button>
                </div>
            </div>
        </section>

    <!-- Se√ß√£o: Planos -->
    <section id="plans" class="content-section" style="display:none;">
        <div class="page-header">
            <h1><i class="fas fa-tags"></i> Planos de Assinatura</h1>
            <button class="btn btn-primary" onclick="openNewPlanModal()">
                <i class="fas fa-plus"></i> Novo Plano
            </button>
        </div>

        <div id="plansContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            <p style="text-align: center; color: #999; grid-column: 1/-1;">Carregando planos...</p>
        </div>
    </section>

    <!-- Se√ß√£o: Integra√ß√µes -->
    <section id="integrations" class="content-section" style="display:none;">
        <div class="page-header">
            <h1><i class="fas fa-plug"></i> Integra√ß√µes</h1>
            <button class="btn btn-primary" onclick="testAllIntegrations()">
                <i class="fas fa-sync-alt"></i> Testar Todas
            </button>
        </div>

        <div class="grid-2">
            <!-- EFI Integration -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-dollar-sign"></i> EFI (Gerencianet)</h3>
                    <span class="badge" id="efi-badge">Desconectado</span>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong> <span id="efi-status">Verificando...</span></p>
                    <p><strong>Ambiente:</strong> <span id="efi-env">-</span></p>
                    <p><strong>Fun√ß√µes:</strong> Pagamentos via PIX, Faturas, Webhooks</p>
                </div>
                <div class="card-actions">
                    <button class="btn btn-sm btn-primary" onclick="openEfiConfig()">
                        <i class="fas fa-cog"></i> Configurar
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="testEfi()">
                        <i class="fas fa-sync"></i> Testar
                    </button>
                </div>
            </div>

            <!-- Z-API Integration -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fab fa-whatsapp"></i> Z-API (WhatsApp)</h3>
                    <span class="badge" id="zapi-badge">Desconectado</span>
                </div>
                <div class="card-body">
                    <p><strong>Status:</strong> <span id="zapi-status">Verificando...</span></p>
                    <p><strong>Inst√¢ncia:</strong> <span id="zapi-instance">-</span></p>
                    <p><strong>Fun√ß√µes:</strong> Notifica√ß√µes, Mensagens, Webhooks</p>
                </div>
                <div class="card-actions">
                    <button class="btn btn-sm btn-primary" onclick="openZapiConfig()">
                        <i class="fas fa-cog"></i> Configurar
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="testZapi()">
                        <i class="fas fa-sync"></i> Testar
                    </button>
                </div>
            </div>
        </div>

        <!-- Webhook Status -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h3><i class="fas fa-webhook"></i> Status de Webhooks</h3>
            </div>
            <div class="card-body">
                <div class="webhook-urls">
                    <p>
                        <strong>EFI:</strong>
                        <code id="webhook-efi">https://seu-dominio.com/webhooks/efi</code>
                        <button class="btn-copy" onclick="copyToClipboard('webhook-efi')"><i class="fas fa-copy"></i></button>
                    </p>
                    <p>
                        <strong>Z-API:</strong>
                        <code id="webhook-zapi">https://seu-dominio.com/webhooks/zapi</code>
                        <button class="btn-copy" onclick="copyToClipboard('webhook-zapi')"><i class="fas fa-copy"></i></button>
                    </p>
                </div>
                <button class="btn btn-primary" onclick="viewWebhookLogs()" style="margin-top: 1rem;">
                    <i class="fas fa-list"></i> Ver Logs
                </button>
            </div>
        </div>
    </section>

    <!-- Modal: Configurar EFI -->
    <div id="efiModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-dollar-sign"></i> Configurar EFI</h2>
                <button class="modal-close" onclick="closeEfiModal()">√ó</button>
            </div>
            <form onsubmit="saveEfiConfig(event)">
                <div class="form-group">
                    <label>Client ID *</label>
                    <input type="text" id="efiClientId" required placeholder="Seu Client ID da EFI">
                </div>
                <div class="form-group">
                    <label>Client Secret *</label>
                    <input type="password" id="efiClientSecret" required placeholder="Seu Client Secret da EFI">
                </div>
                <div class="form-group">
                    <label>Chave PIX *</label>
                    <input type="text" id="efiPixKey" required placeholder="Sua chave PIX (CPF, CNPJ, Email ou Telefone)">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="efiSandbox">
                        Usar ambiente Sandbox (Testes)
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEfiModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Configura√ß√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Configurar Z-API -->
    <div id="zapiModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fab fa-whatsapp"></i> Configurar Z-API</h2>
                <button class="modal-close" onclick="closeZapiModal()">√ó</button>
            </div>
            <form onsubmit="saveZapiConfig(event)">
                <div class="form-group">
                    <label>Instance ID *</label>
                    <input type="text" id="zapiInstance" required placeholder="Seu Instance ID da Z-API">
                </div>
                <div class="form-group">
                    <label>Token *</label>
                    <input type="password" id="zapiToken" required placeholder="Seu Token da Z-API">
                </div>
                <div class="form-group">
                    <label>Security Token</label>
                    <input type="password" id="zapiSecurityToken" placeholder="Token de seguran√ßa (opcional)">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeZapiModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Configura√ß√£o</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Novo/Editar Tenant -->
    <div id="tenantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Novo Provedor</h2>
                <button class="modal-close" onclick="closeTenantModal()">√ó</button>
            </div>
            <form id="tenantForm" onsubmit="saveTenant(event)">
                <div class="form-group">
                    <label>Nome do Provedor *</label>
                    <input type="text" id="tenantName" required placeholder="Ex: Updata Telecom">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Raz√£o Social *</label>
                        <input type="text" id="tenantRazao" required placeholder="Raz√£o social completa">
                    </div>
                    <div class="form-group">
                        <label>CNPJ *</label>
                        <input type="text" id="tenantCnpj" required placeholder="XX.XXX.XXX/XXXX-XX">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Dom√≠nio *</label>
                        <input type="text" id="tenantDomain" required placeholder="updata.com.br">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="tenantEmail" required placeholder="contato@empresa.com.br">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="tenantPhone" placeholder="(92) 9 9142-4261">
                    </div>
                    <div class="form-group">
                        <label>Plano *</label>
                        <select id="tenantPlan" required>
                            <option value="">Selecione um plano</option>
                            <option value="basic">B√°sico - R$ 299/m√™s</option>
                            <option value="professional">Profissional - R$ 599/m√™s</option>
                            <option value="enterprise">Enterprise - R$ 999/m√™s</option>
                        </select>
                    </div>
                </div>

                <fieldset class="form-fieldset">
                    <legend>Cores da Marca</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cor Prim√°ria</label>
                            <input type="color" id="tenantColorPrimary" value="#6366f1">
                        </div>
                        <div class="form-group">
                            <label>Cor Secund√°ria</label>
                            <input type="color" id="tenantColorSecondary" value="#ec4899">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-fieldset">
                    <legend>Configura√ß√£o do Agente MK-Auth</legend>
                    <div class="form-group">
                        <label>URL do Agente</label>
                        <input type="url" id="agenteUrl" placeholder="https://provedor.updata.com.br/api.php">
                    </div>
                    <div class="form-group">
                        <label>Token do Agente</label>
                        <input type="password" id="agenteToken" placeholder="Token de autentica√ß√£o">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Timeout (segundos)</label>
                            <input type="number" id="agenteTimeout" value="30" min="5" max="300">
                        </div>
                        <div class="form-group">
                            <label>Max Retries</label>
                            <input type="number" id="agenteMaxRetries" value="3" min="0" max="10">
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTenantModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Provedor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Alterar Senha -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Alterar Senha</h2>
                <button class="modal-close" onclick="closePasswordModal()">√ó</button>
            </div>
            <form id="passwordForm" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label>Senha Atual *</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="currentPassword" required placeholder="Digite sua senha atual">
                        <button type="button" class="password-toggle" onclick="toggleAdminPasswordVisibility('currentPassword')" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Nova Senha *</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="newPassword" required placeholder="Digite a nova senha">
                        <button type="button" class="password-toggle" onclick="toggleAdminPasswordVisibility('newPassword')" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirmar Senha *</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="confirmPassword" required placeholder="Confirme a nova senha">
                        <button type="button" class="password-toggle" onclick="toggleAdminPasswordVisibility('confirmPassword')" tabindex="-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Alterar Senha</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Plan Modal -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="planModalTitle">Novo Plano</h3>
                <button type="button" class="btn-close" onclick="closePlanModal()">√ó</button>
            </div>
            <form id="planForm" onsubmit="savePlan(event)">
                <div class="form-group">
                    <label>Nome do Plano *</label>
                    <input type="text" id="planNome" required placeholder="Ex: Plano B√°sico">
                </div>
                <div class="form-group">
                    <label>Slug *</label>
                    <input type="text" id="planSlug" required placeholder="Ex: plano-basico">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="planDescricao" placeholder="Descri√ß√£o do plano"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor (R$) *</label>
                        <input type="number" id="planValor" step="0.01" required placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Per√≠odo *</label>
                        <select id="planPeriodo" required>
                            <option value="">Selecione...</option>
                            <option value="mensal">Mensal</option>
                            <option value="trimestral">Trimestral</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Dias de Teste</label>
                        <input type="number" id="planDiasTrial" value="7" min="0">
                    </div>
                    <div class="form-group">
                        <label>Limite de Clientes</label>
                        <input type="number" id="planLimiteClientes" min="-1" placeholder="Deixe vazio para ilimitado">
                    </div>
                </div>
                <div class="form-group">
                    <label>Recursos (um por linha)</label>
                    <textarea id="planRecursos" placeholder="Recurso 1&#10;Recurso 2&#10;Recurso 3" rows="4"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cor do Plano</label>
                        <input type="color" id="planCor" value="#3498db">
                    </div>
                    <div class="form-group">
                        <label>Ordem</label>
                        <input type="number" id="planOrdem" value="0" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="planDestaque">
                            Destacar este plano
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="planAtivo" checked>
                            Ativo
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <label>
                        <input type="checkbox" id="planRecorrente">
                        Plano recorrente (cobran√ßa autom√°tica)
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePlanModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Plano</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Verificar autentica√ß√£o antes de carregar o app
        (function() {
            console.log('üîç Admin index - Checking authentication...');
            const token = localStorage.getItem('admin_token');
            console.log('üîë Admin index - Token exists:', !!token);
            
            if (!token) {
                console.log('‚ùå No token found, redirecting to login...');
                window.location.replace('/admin/login');
                return;
            }
            
            // Token existe, pode carregar a p√°gina normalmente
            console.log('‚úÖ Admin autenticado - Token:', token.substring(0, 20) + '...');
        })();
    </script>

    <script src="app.js"></script>
</body>
</html>
